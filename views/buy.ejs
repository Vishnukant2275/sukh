<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Buy Products - FPO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      body {
        background: #f8fafc;
      }
      .card {
        border: none;
        border-radius: 18px;
        overflow: hidden;
        transition: box-shadow 0.2s, transform 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .card:hover {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.14);
        transform: translateY(-4px) scale(1.02);
      }
      .card-img-top {
        height: 220px;
        object-fit: cover;
        border-bottom: 1px solid #eee;
      }
      .product-badge {
        position: absolute;
        top: 16px;
        left: 16px;
        background: #fff;
        color: #198754;
        font-weight: 600;
        padding: 0.25em 0.75em;
        border-radius: 12px;
        font-size: 0.95em;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      .btn-group .btn {
        min-width: 120px;
      }
      .card-footer {
        background: transparent;
        border-top: none;
      }
      .price-tag {
        font-size: 1.25rem;
        font-weight: bold;
        color: #198754;
      }
      .card-title {
        font-size: 1.2rem;
        font-weight: 600;
      }
      .card-text {
        color: #555;
      }
      .btn.active,
      .btn:active {
        background-color: #198754 !important;
        color: #fff !important;
        border-color: #198754 !important;
      }
      .btn.active i {
        color: #fff !important;
      }

      /* Mobile-specific positioning */
      @media (max-width: 991.98px) {
        .logout-mobile {
          position: absolute;
          right: 16px;
          top: 8px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar Start -->
    <nav
      class="navbar navbar-expand-lg navbar-light bg-white shadow-sm position-relative"
    >
      <div class="container-fluid px-3">
        <!-- Left: Hamburger + Icons -->
        <div class="d-flex align-items-center">
          <button
            class="navbar-toggler me-2"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarContent"
            aria-expanded="true"
            aria-controls="navbarContent"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <!-- <a
            class="btn btn-outline-success position-relative me-2"
            href="#"
            id="cart-btn-navbar"
          >
            <i class="bi bi-cart"></i>
            <span
              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              id="cart-count"
              >0</span
            >
          </a> -->
        </div>

        <!-- Center: Brand -->
        <a class="navbar-brand mx-auto fw-bold text-success" href="/home"
          >Sukhüöúüåæüë®‚Äçüåæ</a
        >

        <!-- Logout Icon for Mobile (absolute right) -->
        <a href="/logout" class="btn btn-danger logout-mobile d-lg-none">
          <i class="bi bi-box-arrow-right"></i>
        </a>

        <!-- Right: Links -->
        <div class="collapse navbar-collapse show" id="navbarContent">
          <ul class="navbar-nav me-4 mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link fw-semibold" href="/home">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-success active fw-semibold" href="/buy"
                >Buy</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link fw-semibold" href="/sell">Sell</a>
            </li>
            <li class="nav-item">
              <a class="nav-link fw-semibold" href="/aboutus">About Us</a>
            </li>
            <li class="nav-item">
              <a class="nav-link fw-semibold" href="/contact">Contact Us</a>
            </li>
            <li class="nav-item">
              <a class="nav-link fw-semibold" href="/profile">My Profile</a>
            </li>
          </ul>

          <!-- Search -->
          <form class="d-flex mx-auto my-2" style="max-width: 400px">
            <input
              class="form-control me-2"
              type="search"
              placeholder="Search products..."
              aria-label="Search"
            />
            <button class="btn btn-outline-success" type="submit">
              Search
            </button>
          </form>

          <!-- Profile & Logout for Desktop -->
          <ul
            class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center d-none d-lg-flex"
          >
            <li class="nav-item me-2">
              <a class="btn btn-outline-secondary" href="/profile">
                <i class="bi bi-person"></i> Profile
              </a>
            </li>
            <li class="nav-item ms-2">
              <a class="btn btn-danger" href="/logout">
                <i class="bi bi-box-arrow-right"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Navbar End -->

    <!-- Product Section -->
    <div class="container-fluid py-5">
      <h1 class="mb-4 text-center fw-bold text-success">
        <%= user.name%>, Buy Fresh Produce
      </h1>

      <div class="row g-4">
        <% if (products && products.length > 0) { %> <%
        products.forEach((product)=>{%>
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <div class="card position-relative h-100">
            <% if (product.image && product.image.data) { %>
            <a
              href="/product/<%= product._id %>"
              style="text-decoration: none; color: inherit"
            >
              <img
                src="data:<%= product.image.contentType %>;base64,<%= product.image.data.toString('base64') %>"
                class="card-img-top"
                alt="<%= product.name %>"
                onerror="this.src='https://via.placeholder.com/300x220?text=Error+Loading+Image'"
            /></a>
            <% } else { %>
            <img
              src="https://via.placeholder.com/300x220?text=No+Image"
              class="card-img-top"
              alt="No Image"
            />
            <% } %>
            <div class="product-badge">Fresh</div>
            <div class="card-body d-flex flex-column">
              <h5 class="card-title"><%= product.name %></h5>
              <p class="card-text text-truncate"><%= product.description %></p>
              <div class="mt-auto">
                <p class="price-tag mb-2">‚Çπ<%= product.price %></p>
                <div class="btn-group w-100" role="group">
                  <!-- <button
                    class="btn btn-outline-success cart-btn"
                    data-product="<%= product._id %>"
                  >
                    <i class="bi bi-cart-plus"></i>
                  </button> -->
                  <button
                    class="btn btn-outline-success"
                    onclick="buyNow('<%= product._id %>')"
                  >
                    Buy Now
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <% }); %> <% } else { %>
        <div class="col-12 text-center">
          <p class="text-muted">No products available at the moment.</p>
        </div>
        <% } %>
      </div>

      <!-- Close row -->
    </div>
    <!-- Close container -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const cart = new Set();

      function updateCounters() {
        document.getElementById("cart-count").textContent = cart.size;
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Force navbar to be unfolded on page load (for mobile)
        const navbarContent = document.getElementById("navbarContent");
        if (navbarContent && !navbarContent.classList.contains("show")) {
          navbarContent.classList.add("show");
        }

        document.querySelectorAll(".cart-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const pid = this.getAttribute("data-product");
            if (cart.has(pid)) {
              cart.delete(pid);
              this.classList.remove("active");
            } else {
              cart.add(pid);
              this.classList.add("active");
            }
            updateCounters();
          });
        });
      });
      function buyNow(productId) {
        // Redirect to a purchase page or handle the buy now logic
        window.location.href = `/purchase/${productId}`;
      }
    </script>
  </body>
</html>
